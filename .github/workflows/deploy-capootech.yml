name: Deploy CapooTech Official Site

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: capootech-official-site-prod
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TARGET_HOST: ${{ secrets.HOST_CN_SHANGHAI }}
      SSH_USER: ${{ secrets.SSH_USER_CN_SHANGHAI }}
      SSH_PORT: ${{ secrets.SSH_PORT_CN_SHANGHAI }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare release metadata
        id: meta
        shell: bash
        run: |
          set -euxo pipefail
          release_id="$(date +%Y%m%d%H%M%S)-${GITHUB_SHA::7}"
          echo "release_id=${release_id}" >> "${GITHUB_OUTPUT}"

      - name: Prepare SSH
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${TARGET_HOST}" || -z "${SSH_USER}" || -z "${SSH_PORT}" ]]; then
            echo "Missing Shanghai SSH settings" >&2
            exit 1
          fi

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s' "${{ secrets.SSH_PRIVATE_KEY_CN_SHANGHAI }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keygen -y -f ~/.ssh/id_rsa >/dev/null
          ssh-keyscan -p "${SSH_PORT}" -H "${TARGET_HOST}" >> ~/.ssh/known_hosts
          ssh -p "${SSH_PORT}" -o BatchMode=yes -o ConnectTimeout=10 -i ~/.ssh/id_rsa "${SSH_USER}@${TARGET_HOST}" "echo ssh-ok"

      - name: Create release dir
        shell: bash
        run: |
          set -euxo pipefail
          release_id="${{ steps.meta.outputs.release_id }}"
          ssh -p "${SSH_PORT}" -i ~/.ssh/id_rsa "${SSH_USER}@${TARGET_HOST}" "mkdir -p /opt/sites/capootech/releases/${release_id}"

      - name: Upload release files
        shell: bash
        run: |
          set -euxo pipefail
          release_id="${{ steps.meta.outputs.release_id }}"
          tar -cf - index.html styles.css lang-toggle.js favicon-capoo.svg images \
            | ssh -p "${SSH_PORT}" -i ~/.ssh/id_rsa "${SSH_USER}@${TARGET_HOST}" "tar -xf - -C /opt/sites/capootech/releases/${release_id}"

      - name: Activate release
        id: activate
        shell: bash
        run: |
          set -euxo pipefail
          release_id="${{ steps.meta.outputs.release_id }}"
          old_target="$(ssh -p "${SSH_PORT}" -i ~/.ssh/id_rsa "${SSH_USER}@${TARGET_HOST}" "readlink -f /opt/sites/capootech/current || true")"
          echo "old_target=${old_target}" >> "${GITHUB_OUTPUT}"

          ssh -p "${SSH_PORT}" -i ~/.ssh/id_rsa "${SSH_USER}@${TARGET_HOST}" "\
            set -euo pipefail; \
            find /opt/sites/capootech/releases/${release_id} -type d -exec chmod 755 {} +; \
            find /opt/sites/capootech/releases/${release_id} -type f -exec chmod 644 {} +; \
            ln -sfn /opt/sites/capootech/releases/${release_id} /opt/sites/capootech/current; \
            nginx -t; \
            systemctl reload nginx"

      - name: Post-deploy health check
        shell: bash
        run: |
          set -euxo pipefail
          for _ in {1..12}; do
            if curl -fsS --max-time 10 https://capootech.com/ > /tmp/capootech-home.html; then
              if grep -q "favicon-capoo.svg" /tmp/capootech-home.html && grep -q "grain.capootech.com" /tmp/capootech-home.html && grep -q "id=\"lang-toggle\"" /tmp/capootech-home.html; then
                exit 0
              fi
            fi
            sleep 5
          done

          echo "Landing health check failed" >&2
          exit 1

      - name: Roll back release on failure
        if: failure() && steps.activate.outputs.old_target != ''
        shell: bash
        run: |
          set -euxo pipefail
          old_target="${{ steps.activate.outputs.old_target }}"

          ssh -p "${SSH_PORT}" -i ~/.ssh/id_rsa "${SSH_USER}@${TARGET_HOST}" "\
            set -euo pipefail; \
            ln -sfn '${old_target}' /opt/sites/capootech/current; \
            nginx -t; \
            systemctl reload nginx"

          echo "Rolled back to ${old_target}" >&2
